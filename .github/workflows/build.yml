name: Build, Test, and Deploy

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  REGISTRY: ${{ secrets.REGISTRY }}
  SONAR_URL: ${{ secrets.SONAR_URL }}
  SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}
  SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  EKS_CLUSTER: vprofile1-eks
  REGION: us-east-2
  #IMAGE_TAG: ${{ github.sha }}
  ECR_REPO_NAME: ${{ secrets.ECR_REPO_NAME }}
  IMAGE_TAG: ${{ github.run_number }}

jobs:

   
  setup-argocd:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout Repository
      - name: Checkout Code
        uses: actions/checkout@v2

      # Step 2: Configure AWS CLI for EKS
      - name: Configure AWS CLI
        run: |
          aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws configure set region ${{env.REGION}}
          aws eks --region ${{env.REGION}} update-kubeconfig --name ${{env.EKS_CLUSTER}}

      # Step 3: Install Argo CD
      - name: Install Argo CD
        run: |
          kubectl create namespace argocd || true
          helm repo add argo-cd https://argoproj.github.io/argo-helm
          helm repo update
          helm install argocd argo-cd/argo-cd --namespace argocd --wait   